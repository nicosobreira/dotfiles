#!/usr/bin/env bash

set -eou pipefail
#set -x

WGET_OUTPUT="-q --show-progress"
DEPENDENCIES="git make tar curl wget unzip"
PACKGES="tree gh tmux stow vim"
HOME_FOLDERS=".config .bin .local"
LOCAL_FOLDERS="bin share state lib"

get_latest_repo_version() {
	local git_user_name=$1
	local git_repo=$2
	echo "$(curl -s "https://api.github.com/repos/${git_user_name}/${git_repo}/releases/latest" | grep -oP '"tag_name": "v\K[0-9.]+' | head -1)"
}

check_need_update() {
	if [[ $# -lt 3 ]]; then
		echo "Error: Less than three arguments"
		return 2
	fi
	local program=$1
	local search_string=$2
	local git_user_name=$3
	local git_repo=${4:-$1}
	local current_version=""
	local latest_version="$(get_latest_repo_version git_repo git_user_name)"
	if command -v "${program}" >/dev/null; then
		current_version=$(${program} --version 2>/dev/null | grep -oP "${search_string}\K[0-9.]+" | head -1)
	fi
	latest_version=$(get_latest_repo_version "${git_user_name}" "${git_repo}")
	if [[ -z $latest_version ]]; then
		echo "Error: Unable to access ${git_user_name}/${git_repo}"
		return 3
	fi
	if [[ "${current_version}" == "${latest_version}" ]]; then
		echo "${program} is already in the latest version ${latest_version}"
		return 1
	fi
	return 0
}

install_yazi() {
	echo -e "\tInstalling Yazi"
	if ! check_need_update "yazi" "Yazi " "sxyazi" "yazi"; then
		return
	fi
	if ! command -v rustup >/dev/null; then
		curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
		if [[ "$SHELL" =~ "fish" ]]; then
			source $HOME/.cargo/env.fish
		elif [[ "$SHELL" =~ "nu" ]]; then
			source $HOME/.cargo/env.nu
		else
			source "$HOME/.cargo/env"
		fi
		rustup update
	fi
	
	local YAZI_REPO="/tmp/yazi"
	if [[ ! -d ${YAZI_REPO} ]]; then
		git clone https://github.com/sxyazi/yazi.git ${YAZI_REPO}
	fi
	cd ${YAZI_REPO}
	cargo build --release --locked
	mv target/release/yazi target/release/ya $HOME/.local/bin/
}

install_zoxide() {
	echo -e "\tInstalling Zoxide"
	curl -sSfL https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | sh
}

install_lazygit() {
	echo -e "\n\tInstalling Lazygit"
	local git_user_name="jesseduffield"
	local git_repo="lazygit"
	if ! check_need_update "lazygit" "version=" "${git_user_name}" "${git_repo}"; then
		return
	fi
	local bin_file="lazygit"
	local tar_file="lazygit.tar.gz"
	local latest_version="$(get_latest_repo_version "${git_user_name}" "${git_repo}")"
	cd /tmp
	wget ${WGET_OUTPUT} -O ${tar_file} \
		"https://github.com/jesseduffield/lazygit/releases/download/v${latest_version}/lazygit_${latest_version}_Linux_x86_64.tar.gz"
	echo "Extract ${tar_file}"
	tar xf ${tar_file} ${bin_file}
	echo "Installing lazygit"
	install ${bin_file} -D -t $HOME/.local/bin
}

install_neovim() {
	echo -e "\n\tInstalling Neovim"
	#sudo apt install npm python3-full
	if ! check_need_update "nvim" "v" "neovim" "neovim"; then
		return
	fi
	cd /tmp
	local folder_name="nvim-linux-x86_64"
	local tar_file="/tmp/${folder_name}.tar.gz"
	local folders=("bin" "lib" "share")
	wget ${WGET_OUTPUT} -O ${tar_file} \
		https://github.com/neovim/neovim/releases/latest/download/${folder_name}.tar.gz
	tar -xzf ${tar_file}
	for dir in "${folders[@]}"; do
		cp -R ${folder_name}/${dir}/* $HOME/.local/${dir}
	done
}

install_all() {
	echo -e "\tInstalling packges: ${PACKGES}"
	sudo apt install ${PACKGES}
	install_zoxide
	install_yazi
	install_neovim
	install_lazygit
}

create_folders() {
	local destination=$1
	local folders=$2

	IFS=' ' read -r -a array_folders <<< "$folders"

	for folder in "${array_folders[@]}"; do
		folder="${destination}/${folder}"
		[[ -d ${folder} ]] && continue

		echo "Creating ${folder}"
		mkdir -p ${folder}
	done
}

clone_dotfiles() {
	local DOTFILES="$HOME/dotfiles"
	if [[ ! -d "${DOTFILES}" ]]; then
		git clone https://github.com/nicosobreira/dotfiles "${DOTFILES}"
	fi
}

show_help() {
	cat << EOF
Usage: $0 [OPTIONS] [APPS]

OPTIONS:
	install [APPS]	App names to install
	help			See help
APPS:
	all			Install all apps
	neovim
	yazi
	zoxide
	lazygit

Examples:
	$0 install neovim yazi
	$0 install all
EOF
}

if [[ $# -eq 0 ]]; then
	echo "Error: Type at least one argument"
	show_help
	exit 1
fi

while [[ $# -gt 0 ]]; do
	case "$1" in
		install)
			shift
			echo -e "\tInstalling dependencies: ${DEPENDENCIES}"
			sudo apt install ${DEPENDENCIES}
			create_folders "$HOME" "${HOME_FOLDERS}"
			create_folders "$HOME/.local" "${LOCAL_FOLDERS}"
			clone_dotfiles
			for app in "$@"; do
				case "${app}" in
					neovim) install_neovim;;
					yazi) install_yazi;;
					zoxide) install_zoxide;;
					lazygit) install_lazygit;;
					all)
						install_all
						;;
					*)
						echo "Unkown app \"${app}\""
						show_help
						exit 2
						;;
				esac
			done
			break
			;;
		help)
			show_help
			break
			;;
		*)
			echo "Error: Unkown argument \"${1}\""
			show_help
			exit 1
			;;
	esac
done
