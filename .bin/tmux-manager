#!/usr/bin/env bash

set -eou pipefail

if [[ -t 2 && -z "${NO_COLOR:-}" ]]; then
  if command -v tput &>/dev/null && \
	  tput colors &>/dev/null; then
    RED="$(tput setaf 1)"
    BOLD="$(tput bold)"
    RESET="$(tput sgr0)"
  fi
fi

error() {
  local msg="$1"
  local code="${2:-1}"

  local error_string="ERROR"

  if [[ -n "${RED:-}" ]]; then
    printf '%s%s%s:%s %s\n' "$BOLD" "$RED" "$error_string" "$RESET" "$msg" >&2
  else
    printf '%s: %s\n' "$error_string" "$msg" >&2
  fi

  exit "$code"
}

if ! command -v tmux &>/dev/null; then
	error "Tmux executable not found" 3
fi

# Global variables
SEARCH_FOLDERS="$HOME/code"

# Functions
show_help()
{
	cat <<- EOF
	Usages:
		tmux-manager path/to/directory
		tmux-manager -p [Prompt mode]
		tmux-manager -h [This help]
EOF
}

nix_shell_hook()
{
	local session_path
	session_path="$1"

	if [[ -f "$session_path/shell.nix" ]]; then
		local hook_command='send-keys "nix-shell" C-m'
		
		tmux set-hook after-new-window "$hook_command"
		tmux set-hook after-rename-window "$hook_command"
	fi
}

create_session_windows()
{
	local session_name session_path
	session_name="$1"
	session_path="$2"
	
	nix_shell_hook "$session_path"
	
	tmux new-window -c "$session_path" -t "$session_name:1" -d -n "code" &>/dev/null || tmux rename-window -t "$session_name:1" "code"
	tmux new-window -c "$session_path" -t "$session_name:2" -d -n "run" &>/dev/null || tmux rename-window -t "$session_name:2" "run"
}

get_session_name()
{
	local session_path
	session_path="$1"

	basename "$session_path" | tr . _
}

# If session_path is valid return 0 (TRUE), else return 1 (FALSE) and echo error message to stderr
validate_session_path()
{
	local session_path
	session_path="$1"

	if [[ -d "$session_path" ]]; then
		return 0
	fi

	session_name="$(get_session_name "$session_path")"

	if tmux has-session -t "$session_name" 2>/dev/null; then
		return 0
	fi

	error "The directory \"$session_path\" or session \"$session_name\" does not exist"
}

get_session_fzf()
{
	local selection

	selection=$(
		{
			echo "--- Tmux Sessions ---"
			tmux list-sessions -F "#{session_name}" 2>/dev/null
			echo "--- Hot Directories ---"
			echo "$HOME/nixos"
			echo "$HOME/.config/awesome"
			echo "$HOME/.config/nvim"
			echo "--- Project Directories ---"
			find "$SEARCH_FOLDERS" -mindepth 1 -maxdepth 2 -type d 2>/dev/null
		} | fzf --prompt="Select a directory or session: " --header-first --layout "reverse"
	)

	if [[ -z ${selection+x} ]]; then
		return 1
	fi

	if [[ "$selection" == ---* ]]; then
		return 2
	fi

	if ! validate_session_path "$selection"; then
		return 3
	fi

	echo "$selection"
}

input_work_folder()
{
	local input_path session_path
	while :
	do
		read -r -e -p "Enter a directory/session: [None to fzf] " input_path

		if [[ -z $input_path ]]; then
			session_path="$(get_session_fzf)"
			break
		fi

		session_path="${input_path/#\~/"$HOME"}"

		if validate_session_path "$session_path"; then
			break
		fi

		echo "Please try again" >&2
	done

	echo "$session_path"
}

SESSION_PATH=""
SESSION_NAME=""

if [[ $# -eq 0 ]]; then
	SESSION_PATH="$(get_session_fzf)"
elif [[ $# -eq 1 ]]; then
	if [[ $1 == -p ]]; then
		SESSION_PATH="$(input_work_folder)"
	elif [[ $1 == -h ]]; then
		show_help
		exit 0
	elif [[ $1 == . ]]; then
		SESSION_PATH="$PWD"
	else
		if ! validate_session_path "$1"; then
			show_help
			exit 2
		fi

		SESSION_PATH="$1"
	fi
else
	show_help
	error "More than 2 arguments"
fi

SESSION_NAME="$(get_session_name "$SESSION_PATH")"

if  ! tmux list-sessions &>/dev/null || \
	! tmux has-session -t "$SESSION_NAME" &>/dev/null
then
	tmux new-session -d -s "$SESSION_NAME" -c "$SESSION_PATH"
	create_session_windows "$SESSION_NAME" "$SESSION_PATH"
fi

if [[ -z ${TMUX+x} ]]; then
	tmux attach-session -t "$SESSION_NAME"
else
	tmux switch-client -t "$SESSION_NAME"
fi
